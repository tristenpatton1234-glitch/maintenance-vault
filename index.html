<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Vault v6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .due-alarm { border: 2px solid #ef4444; background: rgba(239, 68, 68, 0.05); }
        input, select, textarea { background-color: #334155 !important; border-color: #475569 !important; color: white !important; }
        .spec-grid { display: none; }
        .spec-grid.open { display: grid; }
        /* Photo thumbnail styling */
        .part-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 0.5rem; display: none; }
        .part-thumb.has-img { display: block; }
    </style>
</head>
<body class="p-2 sm:p-6 font-sans">

    <header class="max-w-6xl mx-auto mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <div>
                <h1 class="text-3xl font-bold text-blue-400 tracking-tight"><i class="fas fa-truck-pickup mr-2"></i>Maintenance Vault</h1>
                <div class="text-slate-500 text-sm font-mono mt-1">v6.0 â€¢ Photos & Alerts</div>
            </div>
            <div class="flex gap-4">
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 text-right">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Current Odometer</div>
                    <input type="number" id="globalOdo" onchange="saveSpecs(); renderParts();" class="bg-transparent border-none text-right font-bold text-yellow-400 w-24 outline-none p-0" placeholder="000000">
                </div>
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 text-right">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Total Invested</div>
                    <div id="grandTotal" class="text-2xl font-bold text-green-400">$0.00</div>
                </div>
            </div>
        </div>

        <div class="card rounded-xl p-4 mb-6">
            <div class="flex justify-between items-center cursor-pointer" onclick="toggleSpecs()">
                <h2 class="font-bold text-lg text-slate-200"><i class="fas fa-id-card mr-2 text-blue-500"></i>Vehicle Profile</h2>
                <i id="specArrow" class="fas fa-chevron-down text-slate-400 transition-transform"></i>
            </div>
            <div id="specContainer" class="spec-grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-slate-700">
                <div><label class="text-[10px] uppercase font-bold text-slate-500">VIN</label><input type="text" id="specVin" onchange="saveSpecs()" class="w-full p-2 rounded text-sm font-mono text-blue-300 uppercase"></div>
                <div><label class="text-[10px] uppercase font-bold text-slate-500">Vehicle Name</label><input type="text" id="specName" onchange="saveSpecs()" class="w-full p-2 rounded text-sm"></div>
                <div><label class="text-[10px] uppercase font-bold text-slate-500">Engine Oil</label><input type="text" id="specOil" onchange="saveSpecs()" class="w-full p-2 rounded text-sm"></div>
                <div><label class="text-[10px] uppercase font-bold text-slate-500">Tire Pressure</label><input type="text" id="specTires" onchange="saveSpecs()" class="w-full p-2 rounded text-sm"></div>
                <div><label class="text-[10px] uppercase font-bold text-slate-500">Oil Filter</label><input type="text" id="specFilter" onchange="saveSpecs()" class="w-full p-2 rounded text-sm"></div>
                <div><label class="text-[10px] uppercase font-bold text-slate-500">Battery</label><input type="text" id="specBattery" onchange="saveSpecs()" class="w-full p-2 rounded text-sm"></div>
            </div>
        </div>

        <div class="flex gap-2 mb-4">
            <button onclick="openModal()" class="flex-grow py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg text-sm">+ Add Part</button>
            <button onclick="exportToCSV()" class="px-4 bg-green-800 text-white rounded-xl font-bold"><i class="fas fa-file-excel"></i></button>
            <button onclick="document.getElementById('importFile').click()" class="px-4 bg-slate-700 text-white rounded-xl font-bold"><i class="fas fa-upload"></i></button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
            <button onclick="enableNotifications()" class="px-4 bg-yellow-600 text-white rounded-xl font-bold"><i class="fas fa-bell"></i></button>
        </div>

        <div class="flex gap-3 mb-4">
            <input type="text" id="searchInput" placeholder="Search..." class="flex-grow p-3 rounded-xl outline-none border border-slate-700">
            <select id="hubFilter" class="p-3 rounded-xl outline-none border border-slate-700 font-bold bg-slate-800">
                <option value="all">Show All</option>
                <option value="vehicle">Vehicle</option>
                <option value="home">Home</option>
            </select>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <div id="partsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center p-4 z-50">
        <div class="card w-full max-w-lg rounded-2xl p-6 border-slate-600 shadow-2xl overflow-y-auto max-h-screen">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Part Details</h2>
            <form id="partForm" class="space-y-3">
                <input type="hidden" id="editId">
                <select id="hub" class="w-full p-3 rounded-lg"><option value="vehicle">Vehicle</option><option value="home">Home/Shop</option></select>

                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 text-center cursor-pointer" onclick="document.getElementById('photoInput').click()">
                    <i class="fas fa-camera text-2xl text-slate-400 mb-1"></i>
                    <div class="text-[10px] text-slate-500 uppercase font-bold">Attach Photo of Part/Box</div>
                    <img id="previewImg" class="w-full h-32 object-contain hidden mt-2 rounded">
                    <input type="file" id="photoInput" class="hidden" accept="image/*" capture="environment" onchange="handlePhoto(this)">
                    <input type="hidden" id="photoData"> </div>

                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] uppercase font-bold text-slate-500">Time (Mo)</label><input type="number" id="interval" class="p-3 rounded-lg w-full"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-500">Use (Mi/Hr)</label><input type="number" id="intervalMiles" class="p-3 rounded-lg w-full"></div>
                </div>

                <input type="text" id="itemName" placeholder="Item Name" class="w-full p-3 rounded-lg" required>
                <input type="text" id="partNum" placeholder="Part Number" class="w-full p-3 rounded-lg" required>
                <div class="relative"><span class="absolute left-3 top-3 text-slate-400">$</span><input type="number" step="0.01" id="cost" placeholder="Cost per Service" class="w-full p-3 pl-8 rounded-lg" required></div>

                <div id="initialGroup" class="p-3 bg-slate-800 rounded-lg border border-slate-700">
                    <div class="text-xs font-bold text-blue-400 mb-2">Last Service Details</div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="lastDate" class="w-full p-2 rounded text-sm">
                        <input type="number" id="lastMileage" class="w-full p-2 rounded text-sm" placeholder="Odometer">
                    </div>
                </div>

                <textarea id="notes" placeholder="Notes..." class="w-full p-3 rounded-lg h-20"></textarea>
                <div class="flex gap-3 mt-2">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-lg bg-slate-700 font-bold">Cancel</button>
                    <button type="submit" class="flex-1 py-3 rounded-lg bg-blue-600 font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let parts = JSON.parse(localStorage.getItem('vault_parts')) || [];
        let specs = JSON.parse(localStorage.getItem('vault_specs')) || {};

        function loadSpecs() {
            document.getElementById('specVin').value = specs.vin || ''; document.getElementById('specName').value = specs.name || '';
            document.getElementById('specOil').value = specs.oil || ''; document.getElementById('specTires').value = specs.tires || '';
            document.getElementById('specFilter').value = specs.filter || ''; document.getElementById('specBattery').value = specs.battery || '';
            document.getElementById('globalOdo').value = specs.odometer || '';
        }
        function saveSpecs() {
            specs = { vin: document.getElementById('specVin').value, name: document.getElementById('specName').value, oil: document.getElementById('specOil').value, tires: document.getElementById('specTires').value, filter: document.getElementById('specFilter').value, battery: document.getElementById('specBattery').value, odometer: parseInt(document.getElementById('globalOdo').value) || 0 };
            localStorage.setItem('vault_specs', JSON.stringify(specs));
        }
        function toggleSpecs() { document.getElementById('specContainer').classList.toggle('open'); document.getElementById('specArrow').classList.toggle('fa-rotate-180'); }
        function saveAndRender() { localStorage.setItem('vault_parts', JSON.stringify(parts)); renderParts(); checkAlerts(); }

        // --- PHOTO LOGIC ---
        function handlePhoto(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Resize image to save space (Simple canvas approach)
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 500; // Limit width to keep storage small
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('previewImg').src = dataUrl;
                        document.getElementById('previewImg').classList.remove('hidden');
                        document.getElementById('photoData').value = dataUrl;
                    }
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- NOTIFICATIONS ---
        function enableNotifications() {
            if (!("Notification" in window)) { alert("This browser does not support notifications."); return; }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") { new Notification("Alerts Enabled!", { body: "You will be notified of overdue maintenance." }); checkAlerts(); }
            });
        }

        function checkAlerts() {
            if (Notification.permission !== "granted") return;
            const overdueCount = document.querySelectorAll('.due-alarm').length;
            if (overdueCount > 0) {
                new Notification("Maintenance Alert", { body: `You have ${overdueCount} items overdue for service!` });
            }
        }

        function renderParts() {
            const list = document.getElementById('partsList');
            const term = document.getElementById('searchInput').value.toLowerCase();
            const hubFilter = document.getElementById('hubFilter').value;
            const currentOdo = specs.odometer || 0;
            list.innerHTML = '';
            let grandTotal = 0;

            parts.filter(p => (p.itemName.toLowerCase().includes(term) || p.partNum.toLowerCase().includes(term)) && (hubFilter === 'all' || p.hub === hubFilter)).forEach(p => {
                const latestDate = p.history && p.history.length > 0 ? p.history[0].date : (p.lastDate || 'N/A');
                let isTimeOverdue = false;
                if(latestDate !== 'N/A' && p.interval > 0) {
                     if(((new Date().getFullYear() - new Date(latestDate).getFullYear()) * 12 + (new Date().getMonth() - new Date(latestDate).getMonth())) >= p.interval) isTimeOverdue = true;
                }
                const latestMile = p.history && p.history.length > 0 ? p.history[0].mile : (p.lastMileage || 0);
                let isMileOverdue = false, milesDriven = 0;
                if(latestMile > 0 && currentOdo > 0) {
                    milesDriven = currentOdo - latestMile;
                    if(p.intervalMiles > 0 && milesDriven >= p.intervalMiles) isMileOverdue = true;
                }
                grandTotal += (parseFloat(p.cost) || 0) * ((p.history || []).length || 1);
                const isOverdue = isTimeOverdue || isMileOverdue;

                const div = document.createElement('div');
                div.className = `card rounded-2xl p-5 ${isOverdue ? 'due-alarm' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between mb-2"><span class="text-[10px] font-bold text-blue-300 uppercase bg-blue-900/30 px-2 py-1 rounded">${p.hub}</span><div class="flex gap-3"><button onclick="editPart(${p.id})" class="text-slate-500 hover:text-blue-400"><i class="fas fa-pencil-alt"></i></button><button onclick="deletePart(${p.id})" class="text-slate-500 hover:text-red-400"><i class="fas fa-trash"></i></button></div></div>
                    <img src="${p.photo || ''}" class="part-thumb ${p.photo ? 'has-img' : ''}">
                    <div class="flex justify-between items-start"><h3 class="text-lg font-bold text-white leading-tight mb-1">${p.itemName}</h3><span class="text-xs font-mono text-green-400">$${(parseFloat(p.cost)||0).toFixed(2)}</span></div>
                    <div class="bg-slate-900 p-2 my-2 rounded border border-slate-700 flex justify-between items-center"><code class="text-blue-400 font-mono font-bold">${p.partNum}</code></div>
                    <div class="grid grid-cols-2 gap-2 mb-3 text-xs"><div><div class="text-slate-500 font-bold uppercase">Time</div><div class="${isTimeOverdue ? 'text-red-400 font-bold' : 'text-slate-300'}">${latestDate}</div></div><div class="text-right"><div class="text-slate-500 font-bold uppercase">Usage</div><div class="${isMileOverdue ? 'text-red-400 font-bold' : 'text-slate-300'}">${milesDriven > 0 ? milesDriven + ' mi ago' : 'No Data'}</div></div></div>
                    <div class="flex gap-2"><button onclick="toggleHistory(${p.id})" class="flex-1 bg-slate-800 text-slate-400 text-xs py-2 rounded font-bold">History</button><button onclick="logService(${p.id})" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 rounded shadow-lg">Log</button></div>
                    <div id="hist-${p.id}" class="hidden mt-3 bg-black/30 p-2 rounded text-xs text-slate-400 h-24 overflow-y-auto">${(p.history || []).map(h => `<div class="border-b border-slate-700 py-1 flex justify-between"><span>${h.date}</span><span>${h.mile} mi</span></div>`).join('')}</div>
                `;
                list.appendChild(div);
            });
            document.getElementById('grandTotal').innerText = '$' + grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function openModal(isEdit = false) {
            document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').classList.add('flex'); document.getElementById('modalTitle').innerText = isEdit ? "Edit Part" : "Add New Part"; document.getElementById('initialGroup').style.display = isEdit ? 'none' : 'block';
            if(!isEdit) { document.getElementById('previewImg').src = ''; document.getElementById('previewImg').classList.add('hidden'); document.getElementById('photoData').value = ''; }
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex'); document.getElementById('partForm').reset(); document.getElementById('editId').value = ''; }
        function savePart(e) {
            e.preventDefault(); const editId = document.getElementById('editId').value;
            const newData = {
                hub: document.getElementById('hub').value, itemName: document.getElementById('itemName').value, partNum: document.getElementById('partNum').value,
                interval: parseInt(document.getElementById('interval').value) || 0, intervalMiles: parseInt(document.getElementById('intervalMiles').value) || 0,
                cost: parseFloat(document.getElementById('cost').value) || 0, notes: document.getElementById('notes').value,
                photo: document.getElementById('photoData').value
            };
            if (editId) { const index = parts.findIndex(p => p.id == editId); if (index > -1) Object.assign(parts[index], newData); }
            else { parts.push({ ...newData, id: Date.now(), history: [{date: document.getElementById('lastDate').value || new Date().toISOString().split('T')[0], mile: parseInt(document.getElementById('lastMileage').value) || 0}] }); }
            saveAndRender(); closeModal();
        }
        function editPart(id) {
            const p = parts.find(x => x.id === id); if (p) {
                document.getElementById('editId').value = p.id; document.getElementById('hub').value = p.hub; document.getElementById('itemName').value = p.itemName; document.getElementById('partNum').value = p.partNum;
                document.getElementById('interval').value = p.interval; document.getElementById('intervalMiles').value = p.intervalMiles || ''; document.getElementById('cost').value = p.cost || 0; document.getElementById('notes').value = p.notes;
                if(p.photo) { document.getElementById('previewImg').src = p.photo; document.getElementById('previewImg').classList.remove('hidden'); document.getElementById('photoData').value = p.photo; }
                else { document.getElementById('previewImg').classList.add('hidden'); document.getElementById('photoData').value = ''; }
                openModal(true);
            }
        }
        function deletePart(id) { if(confirm('Delete?')) { parts = parts.filter(p => p.id !== id); saveAndRender(); } }
        function logService(id) {
            const d = prompt("Service Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
            if (d) {
                const currentOdo = specs.odometer || 0; const m = prompt("Service Mileage:", currentOdo);
                if(m) { const p = parts.find(x => x.id === id); if(!p.history) p.history = []; p.history.unshift({date: d, mile: parseInt(m)}); saveAndRender(); }
            }
        }
        function toggleHistory(id) { document.getElementById(`hist-${id}`).classList.toggle('hidden'); }
        function exportToCSV() { let csv = "Item,Part #,Cost,Last Date,Total Spent\n"; parts.forEach(p => { csv += `"${p.itemName}","${p.partNum}",${p.cost},${(p.history[0]||{}).date},${(p.cost||0)*(p.history||[]).length}\n`; }); const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "maintenance_v6.csv"; link.click(); }
        function importData(e) { const r = new FileReader(); r.onload = function(evt) { if(confirm("Overwrite?")) { parts = JSON.parse(evt.target.result); saveAndRender(); } }; r.readAsText(e.target.files[0]); }

        document.getElementById('partForm').addEventListener('submit', savePart);
        document.getElementById('searchInput').addEventListener('input', renderParts);
        document.getElementById('hubFilter').addEventListener('change', renderParts);
        loadSpecs(); renderParts();
    </script>
</body>
</html>
